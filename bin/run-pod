#!/usr/bin/env ruby

require 'json'
namespace = ARGV[0]
pod_command = ARGV[1] || '/bin/sh'

fail "namespace not given" unless namespace

output = `kubectl get pods -n #{namespace} -o json`.strip
json = JSON.parse output.strip

pods = json["items"].map do |i|
  OpenStruct.new(
    name: i["metadata"]["name"],
    status: i["status"]["containerStatuses"][0]["state"].keys[0])
end

puts "Available pods:"
pods.each do |pod|
  puts "#{pod.name} #{pod.status}"
end

runnning_pod = pods.detect { |pod| pod.status == "running" }

fail "No running pod" unless runnning_pod

command = "kubectl exec -n #{namespace} -it #{runnning_pod.name} -- #{pod_command}"
puts command
system(command)
